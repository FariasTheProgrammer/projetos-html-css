<!doctype html>
<html lang="pt-br">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="icon" href="img/logo.svg" />
    <!-- Bootstrap CSS -->
    <link 
      rel="stylesheet" 
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" 
      integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" 
      crossorigin="anonymous">

    <!-- CSS  -->
    <link rel="stylesheet" href="css/feed.css">
  <title>Página Inicial \ BootClass</title>
  </head>
  <body>
    <div
    aria-live="polite" 
    aria-atomic="true" 
    class="position-relative">
    <div 
      class="position-absolute" 
      id="toast-place" 
      style="top:20px; right:20px; z-index: 1000;"></div>
    </div>

    <div class="container-fluid">
      <div class="row">
        
        <!-- SECTION Esquerda -->
        <div class="col-3 position-fixed sidebar border-right px-4 py-2 logo">
          <!--ANCHOR Meu Perfil-->
          <div class="list-group mt-1">
            <a href="" onclick="localStorage.lembrar = 'false'" class="list-group-item list-group-item-action container">
              <div class="row">
                <div class="col-auto">
                  <img src="img/perfil.svg" alt="" width="60" height="60" class="rounded-circle">
                </div>
                <div class="col-auto text-left">
                  <span id="usernome">Nome do Usário</span>
                  <br>
                  <span>@<span id="useruser">Usuario</span></span>
                </div>
                <div class="col text-right">
                  <img src="img/expandir.svg" alt="" width="20" height="60" >
                </div>
              </div>
            </a>
          </div>

          
          <!--ANCHOR Matérias-->
          <h2 class="mt-3">
            Matérias
            <img src="img/materias.svg" height="30" width="30" alt="">
          </h2>
          <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              Engenharia de Software I
              <span class="badge badge-custom badge-pill">0</span>
            </a>
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              Algorítimo e Lógica de Programação II
              <span class="badge badge-custom badge-pill">0</span>
            </a>
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              Desenvolvimento de Aplicações
              <span class="badge badge-custom badge-pill">0</span>
            </a>
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              Banco de Dados I
              <span class="badge badge-custom badge-pill">0</span>
            </a>
          </div>
        </div>
        <!-- !SECTION -->
        
        <!-- SECTION Centro -->
        <div class="col-5 offset-3 center px-4">

          <!-- ANCHOR Navbar -->
          <nav class="navbar navbar-light bg-light sticky-top mx-n4">
            <span class="badge badge-custom px-4 py-2 rounded-pill">Página Inicial</span>
            <a class="navbar-brand" href="index.html">
              <span class="icon icon-home icon-page"></span>
            </a>
            <a class="navbar-brand" href="#">
              <span class="icon icon-notification"></span>
            </a>
            <a class="navbar-brand" href="#">
              <span class="icon icon-message"></span>
            </a>
          </nav>
          
          <!-- ANCHOR Publicar -->
          <div>
            <div>
              <textarea class="form-control mt-3 input-custom" placeholder="Como foi a Aula?" id="publicagem" style="resize: none;"></textarea>
            </div>
            <div class="mt-2 clearfix">
                <span class="icon icon-imagem float-left mt-1 mx-1"></span>
                <span class="icon icon-arquivo float-left mt-1 mx-1"></span>
                <span class="icon icon-enquete float-left mt-1 mx-1"></span>
                <span class="icon icon-calendario float-left mt-1 mx-1"></span>
                <button type="button" class="btn btn-custom rounded-pill float-right" id="postar" onclick="publicar()">Publicar</button>
            </div>
          </div>

          <hr class="border-custom">

          
          <!-- SECTION Postagens -->
          <div id="feed">

          </div>
          <div class="mt-5 text-center">
            <button type="button" class="btn btn-custom rounded-pill" id="carregar" onclick="carregarMais()">Mostrar Mais</button>
          </div>
          <!-- !SECTION -->

        </div>
        <!-- !SECTION -->
        
        <!-- SECTION Direita -->
        <div class="col-4 offset-8 position-fixed sidebar border-left px-4 py-2">

          <!--ANCHOR Buscar um Perfil-->
          <div class="input-group mt-1 bg-light rounded-pill border-0">
            <div class="input-group-prepend">
              <span class="input-group-text border-left-0 border-top-0 border-bottom-0 border-right bg-transparent mr-n5">@</span>
            </div>
            <input type="text" class="form-control input-custom rounded-pill bg-transparent px-5" placeholder="Buscar um Perfil">
          </div>
          
          <!--ANCHOR Atividades-->
          <h2 class="mt-3">Atividades <img src="img/atividade.svg" height="30" width="30" alt=""></h2>
          <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              Nome da Atividade
              <span class="badge badge-primary badge-pill badge-success">30 dias</span>
            </a>
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              Nome da Atividade
              <span class="badge badge-primary badge-pill badge-warning">10 dias</span>
            </a>
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              Nome da Atividade
              <span class="badge badge-primary badge-pill badge-danger">7 dias</span>
            </a>
          </div>

          <!--ANCHOR Notícias-->
          <h2 class="mt-3">Notícias <img src="img/news.svg" height="30" width="30" alt=""></h2>
          <div class="list-group noticias">
            <a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
              <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">Título da Notícia</h5>
                <small>Data</small>
              </div>
              <p class="mb-1">Resumo</p>
              <small>Site</small>
            </a>
            <a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
              <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">Título da Notícia</h5>
                <small>Data</small>
              </div>
              <p class="mb-1">Resumo</p>
              <small>Site</small>
            </a>
          </div>

          <!--ANCHOR Quem Seguir-->
          <h2 class="mt-3">Quem Seguir <img src="img/seguir.svg" height="30" width="30" alt=""></h2>
          <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action">
              <img src="img/perfil.svg" height="40" class="rounded-circle">
              <strong>Nome do Usuário</strong>
              <span>@usuario</span>
              <button type="button" class="btn btn-custom rounded-pill px-3 float-right">Seguir</button>
            </a>
            <a href="#" class="list-group-item list-group-item-action">
              <img src="img/perfil.svg" height="40" class="rounded-circle">
              <strong>Nome do Usuário</strong>
              <span>@usuario</span>
              <button type="button" class="btn btn-custom rounded-pill px-3 float-right">Seguir</button>
            </a>
            <a href="#" class="list-group-item list-group-item-action">
              <img src="img/perfil.svg" height="40" class="rounded-circle">
              <strong>Nome do Usuário</strong>
              <span>@usuario</span>
              <button type="button" class="btn btn-custom rounded-pill px-3 float-right">Seguir</button>
            </a>
          </div>
        </div>
        <!-- !SECTION -->
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-database.js"></script> 
  <script src="js/init.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  <script src="js/toast.js"></script>

  <script>
    
    var post;
    var data = new Date().toLocaleDateString();
    var nome = localStorage.nome;
    var user = localStorage.user;
    
    $('#usernome').text(nome);
    $('#useruser').text(user);

    window.onunload = () => {
      if(localStorage.lembrar === 'false'){
        let user = localStorage.user;
        localStorage.clear();
        localStorage.user = user;
      }
    }

    var childrenVal=[];
    var childrenKey=[];
    var firstKnownKey = "";
    var oldSize;
    firebase.database().ref('postagens/').orderByKey().limitToLast(5).on('child_added', function(snap, prevChildKey) {
        childrenVal.unshift(snap.val());
        childrenKey.unshift(snap.key);
        firstKnownKey = childrenKey[childrenKey.length-1];
        $('#feed').prepend($(gerarPost(snap.val().User,snap.val().Nome,snap.val().Data,snap.val().Texto)).hide().fadeIn(1000));
        oldSize = childrenVal.length;
    });

    function exclude(key){
      return key.substring(0, key.length - 1) + String.fromCharCode(key.charCodeAt(key.length - 1) - 1)
    }
    
    function carregarMais(){
      firebase.database().ref('postagens/').orderByKey().endAt(exclude(firstKnownKey)).limitToLast(5).once('value').then((snap) => {
        oldSize = childrenKey.length;
        snap.forEach(childSnap => {
          if(childrenKey.indexOf(childSnap.key) === -1){
            childrenVal.unshift(childSnap.val());
            childrenKey.unshift(childSnap.key);
          }
        });
        firstKnownKey = childrenKey[4];
        childrenVal.forEach((postagem, index) => {
            if(index<childrenKey.length - oldSize)
              $('#feed').append($(gerarPost(postagem.User, postagem.Nome, postagem.Data, postagem.Texto)).hide().fadeIn(1000));
        })
      });
    }

    function gerarPost(user, nome, data, texto){
      return `
      <div class="card mt-5">
            <div class="container">
              <div class="row card-header bg-white">
                <div class="col-auto">
                  <img src="img/perfil.svg" height="40" class="rounded-circle">
                </div>
                <div class="col">
                  <strong>${nome}</strong>
                  <span>@${user}</span>
                  <span class="float-right">${data}</span>
                </div>
              </div>

              <div class="card-body text-justify">
                ${texto}
              </div>

              <div class="row text-center card-footer">
                <div class="col">
                  <span class="icon icon-comentar"></span>
                  <span class="badge badge-pill badge-primary">0</span>
                </div>
                <div class="col">
                  <span class="icon icon-curti"></span>
                  <span class="badge badge-pill badge-primary">0</span>
                </div>
                <div class="col">
                  <span class="icon icon-compartilhar"></span>
                  <span class="badge badge-pill badge-primary">0</span>
                </div>
              </div>
            </div>
          </div>
        `
    }

    function publicar(){
        post = $('#publicagem').val();

        if(post !== ''){
          firebase.database().ref('postagens/').push({
            User: user,
            Nome: nome,
            Texto: post,
            Data: data
          });
          criarToast('Aviso','Postagem Feita!','success');
          $('#publicagem').val('');
        };
      }
  </script>

  </body>
</html>